       

<script>//backup js for index.html
        const API_BASE_URL = 'http://127.0.0.1:5000/v1';

        document.addEventListener('DOMContentLoaded', function() {
            // This is the new script content from index.html
            const authModal = document.getElementById('authModal');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const getStartedBtn = document.getElementById('getStartedBtn');
            const finalCtaBtn = document.getElementById('finalCtaBtn');

            const registerAsSelect = document.getElementById('registerAs');
            const dynamicFormContainer = document.getElementById('dynamic-form-fields');
            const loginForm = document.getElementById('loginForm');
            const registrationForm = document.getElementById('registrationForm');
            const otpForm = document.getElementById('otpForm');
            
            let registeredUser = null;

            const showAuthScreen = (screenId) => {
                authModal.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) targetScreen.classList.add('active');
            };

            const openModal = (screenId) => {
                document.body.classList.add('modal-open'); // Prevents background from scrolling
                authModal.classList.add('active');
                showAuthScreen(screenId);
            };

            const closeModal = () => {
                document.body.classList.remove('modal-open'); // Allows background to scroll again
                authModal.classList.remove('active');
            };

            const generateFormFields = () => {
                dynamicFormContainer.innerHTML = `
                    <div class="form-group"><label for="fullName">Full Name</label><input type="text" id="fullName" class="form-control" required></div>
                    <div class="form-group"><label for="username">Username</label><input type="text" id="username" class="form-control" required></div>
                    <div class="form-group"><label for="address">Address</label><textarea id="address" class="form-control" rows="2" required></textarea></div>
                    <div class="form-group"><label for="phone">Phone Number</label><input type="tel" id="phone" class="form-control" required></div>
                    <div class="form-group"><label for="aadhaar">Aadhaar / PAN Number</label><input type="text" id="aadhaar" class="form-control" required></div>
                    <div class="form-group"><label for="password">Password</label><input type="password" id="password" class="form-control" required></div>
                `;
            };
            
            // Re-routing existing buttons to the new modal
            if(getStartedBtn) getStartedBtn.addEventListener('click', () => openModal('registerScreen'));
            if(finalCtaBtn) finalCtaBtn.addEventListener('click', () => openModal('registerScreen'));


            if(loginBtn) loginBtn.addEventListener('click', () => openModal('loginScreen'));
            if(registerBtn) registerBtn.addEventListener('click', () => openModal('registerScreen'));
            
            authModal.addEventListener('click', (e) => {
                if (e.target === authModal) closeModal();
                if (e.target.classList.contains('switch-link')) {
                    e.preventDefault();
                    showAuthScreen(e.target.dataset.screen);
                }
            });

            if(registerAsSelect) {
                registerAsSelect.addEventListener('change', () => {
                    if (registerAsSelect.value) generateFormFields();
                    else dynamicFormContainer.innerHTML = '';
                });
            }
            
            if(loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const username = document.getElementById('loginUsername').value;
                    let targetPage = '';
                    if (username.toLowerCase().includes('doc')) targetPage = 'doctor.html';
                    else if (username.toLowerCase().includes('admin')) targetPage = 'admin.html';
                    else if (username.toLowerCase().includes('saathi')) targetPage = 'saathi.html';
                    else if (username.toLowerCase().includes('store')) targetPage = 'store.html';
                    else targetPage = 'patient.html';
                    alert(`Login successful! Redirecting...`);
                    window.location.href = targetPage;
                });
            }

            if(registrationForm) {
                registrationForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const role = registerAsSelect.value;
                    if (!role) { alert('Please select a role to register.'); return; }
                    
                    registeredUser = { role: role };
                    alert(`An OTP has been sent to your phone.`);
                    showAuthScreen('otpScreen');
                });
            }
            
            if(otpForm){
                otpForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    let targetPage = '';
                    switch (registeredUser.role) {
                        case 'student': targetPage = 'patient.html'; break;
                        case 'doctor': targetPage = 'doctor.html'; break;
                        case 'store': targetPage = 'store.html'; break;
                        case 'saathi': targetPage = 'saathi.html'; break;
                        case 'admin': targetPage = 'admin.html'; break;
                        default: targetPage = 'patient.html';
                    }
                    alert(`Verification successful! Your account has been created.`);
                    window.location.href = targetPage;
                });
            }

            const otpInputs = document.querySelectorAll('.otp-input');
            otpInputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key >= 0 && e.key <= 9) {
                        otpInputs[index].value = '';
                        setTimeout(() => { if(index + 1 < otpInputs.length) otpInputs[index + 1].focus(); }, 10);
                    } else if (e.key === 'Backspace') {
                         setTimeout(() => { if(index - 1 >= 0) otpInputs[index - 1].focus(); }, 10);
                    }
                });
            });

            // --- Keeping original script functionality that doesn't conflict ---
            const translations = {
                en: { sahara_logo: "SAHARA", contact: "Contact", login: "Login", register: "Register", welcome_title: "Bridging distances with telemedicine", welcome_subtitle: "Instant video consultation, AI support,digital records and real time support available for all", get_started: "Get Started Today", feature1_title: "Confidential Assessments", feature1_desc: "Use clinically-validated screeners like PHQ-9 and GAD-7 to gain insight into your mental well-being.", feature2_title: "24/7 AI Support", feature2_desc: "Our AI-powered assistant is always available to offer coping strategies and a listening ear.", feature3_title: "Resource Library", feature3_desc: "Access a curated library of CBT modules, mindfulness exercises, and educational content.", back_to_home: "← Back to Home", login_type_title: "Select Login Type", login_as_student: "Login as Student", login_as_doctor: "Login as Doctor", login_as_admin: "Login as Admin", no_account: "Don't have an account?", register_here: "Register here.", back: "← Back", student_login: "Student Login", student_id: "Student ID", password: "Password", doctor_login: "Doctor Login", medical_license: "Medical License No.", admin_login: "Admin Login", employee_id: "Employee ID", register_title: "Create Student Account", full_name: "Full Name", email_address: "Email Address", select_college: "Select College", select_stream: "Select Stream", select_year: "Select Year / Semester", already_account: "Already have an account?", login_here: "Login here.", reg_success_title: "Registration Successful!", reg_success_msg: "Your account has been created. Your unique Student ID is:", reg_success_prompt: "Please log in with your new ID.", go_to_login: "Go to Login" },
                hi: { sahara_logo: "सहारा", contact: "संपर्क", login: "लॉग इन करें", register: "पंजीकरण करें", welcome_title: "आपके मन के लिए एक सुरक्षित स्थान", welcome_subtitle: "अपने मानसिक स्वास्थ्य को समझें, सहायता प्राप्त करें, और आपके लिए तैयार किए गए संसाधन खोजें। आपकी সুস্থতার यात्रा यहीं से शुरू होती है।", get_started: "आज ही शुरू करें", feature1_title: "गोपनीय मूल्यांकन", feature1_desc: "अपने मानसिक स्वास्थ्य के बारे में जानकारी प्राप्त करने के लिए PHQ-9 और GAD-7 जैसे चिकित्सकीय रूप से मान्य स्क्रीनर्स का उपयोग करें।", feature2_title: "24/7 एआई सहायता", feature2_desc: "हमारा एआई-संचालित सहायक मुकाबला करने की रणनीतियाँ और सुनने के लिए हमेशा उपलब्ध है।", feature3_title: "संसाधन पुस्तकालय", feature3_desc: "सीबीटी मॉड्यूल, माइंडफुलनेस अभ्यास और शैक्षिक सामग्री की एक क्यूरेटेड लाइब्रेरी तक पहुँचें।", back_to_home: "← होम पर वापस जाएं", login_type_title: "लॉगिन प्रकार चुनें", login_as_student: "छात्र के रूप में लॉगिन करें", login_as_doctor: "डॉक्टर के रूप में लॉगिन करें", login_as_admin: "एडमिन के रूप में लॉगिन करें", no_account: "खाता नहीं है?", register_here: "यहां पंजीकरण करें।", back: "← वापस", student_login: "छात्र लॉगिन", student_id: "छात्र आईडी", password: "पासवर्ड", doctor_login: "डॉक्टर लॉगिन", medical_license: "मेडिकल लाइसेंस नं.", admin_login: "एडमिन लॉगिन", employee_id: "कर्मचारी आईडी", register_title: "छात्र खाता बनाएं", full_name: "पूरा नाम", email_address: "ईमेल पता", select_college: "कॉलेज चुनें", select_stream: "स्ट्रीम चुनें", select_year: "वर्ष / सेमेस्टर चुनें", already_account: "पहले से ही एक खाता है?", login_here: "यहां लॉग इन करें।", reg_success_title: "पंजीकरण सफल!", reg_success_msg: "आपका खाता बन गया है। आपकी विशिष्ट छात्र आईडी है:", reg_success_prompt: "कृपया अपनी नई आईडी से लॉग इन करें।", go_to_login: "लॉगिन पर जाएं" }
            };
            let currentLanguage = 'en';

            function updateUIText() {
                document.querySelectorAll('[data-key]').forEach(element => {
                    const key = element.getAttribute('data-key');
                    if (translations[currentLanguage] && translations[currentLanguage][key]) {
                        element.textContent = translations[currentLanguage][key];
                    } else if (translations['en'] && translations['en'][key]) {
                        element.textContent = translations['en'][key];
                    }
                });
            }
            
            const languageDropdown = document.querySelector('.language-dropdown');
            const dropdownToggle = document.querySelector('.language-dropdown-toggle');
            const languageOptions = document.querySelectorAll('.language-option');
            const selectedLanguageSpan = document.getElementById('selectedLanguage');

            if (languageDropdown) {
                dropdownToggle.addEventListener('click', () => {
                    languageDropdown.classList.toggle('open');
                });

                document.addEventListener('click', (e) => {
                    if (!languageDropdown.contains(e.target)) {
                        languageDropdown.classList.remove('open');
                    }
                });

                languageOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const lang = option.getAttribute('data-lang');
                        const langText = option.textContent;

                        if (lang) {
                            currentLanguage = lang;
                            updateUIText();
                        }
                        
                        selectedLanguageSpan.textContent = langText;
                        languageDropdown.classList.remove('open');
                    });
                });
            }
            
            const testimonialsViewport = document.querySelector('.testimonials-viewport');
            const testimonialsGrid = document.querySelector('.testimonials-grid');
            const testimonials = document.querySelectorAll('.testimonial-card');
            const prevBtn = document.getElementById('testimonial-prev');
            const nextBtn = document.getElementById('testimonial-next');

            if (testimonials.length > 0) {
                let currentIndex = 1;
                let autoPlayTimer;

                function updateCarousel() {
                    if (!testimonials[currentIndex]) return;
                    const activeCard = testimonials[currentIndex];
                    const viewportCenter = testimonialsViewport.offsetWidth / 2;
                    const cardCenter = activeCard.offsetLeft + activeCard.offsetWidth / 2;
                    const scrollAmount = cardCenter - viewportCenter;
                    testimonialsGrid.style.transform = `translateX(-${scrollAmount}px)`;
                    testimonials.forEach((card, index) => {
                        card.classList.toggle('active', index === currentIndex);
                    });
                }

                function setGridPadding() {
                    if (testimonials.length > 0) {
                        const padding = (testimonialsViewport.offsetWidth / 2) - (testimonials[0].offsetWidth / 2);
                        testimonialsGrid.style.padding = `0 ${padding}px`;
                    }
                }

                function moveTo(newIndex) {
                    currentIndex = (newIndex + testimonials.length) % testimonials.length;
                    updateCarousel();
                }

                function startAutoPlay() {
                    stopAutoPlay();
                    autoPlayTimer = setInterval(() => {
                        moveTo(currentIndex + 1);
                    }, 5000);
                }

                function stopAutoPlay() {
                    clearInterval(autoPlayTimer);
                }

                nextBtn.addEventListener('click', () => {
                    stopAutoPlay();
                    moveTo(currentIndex + 1);
                    startAutoPlay();
                });

                prevBtn.addEventListener('click', () => {
                    stopAutoPlay();
                    moveTo(currentIndex - 1);
                    startAutoPlay();
                });
                
                window.addEventListener('resize', () => {
                    setGridPadding();
                    updateCarousel();
                });
                
                setGridPadding();
                moveTo(currentIndex);
                startAutoPlay();
            }

            const feedbackForm = document.getElementById('feedbackForm');
            if(feedbackForm) {
                feedbackForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const feedbackText = document.getElementById('feedbackText').value;
                    if (feedbackText.trim()) {
                        console.log('Feedback submitted:', feedbackText);
                        alert('Thank you for your feedback!');
                        document.getElementById('feedbackText').value = '';
                    } else {
                        alert('Please enter your feedback before submitting.');
                    }
                });
            }

            const fadeInElements = document.querySelectorAll('.fade-in-element');
            if (window.IntersectionObserver) {
                const observer = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 }); 
                
                fadeInElements.forEach(el => {
                    observer.observe(el);
                });
            } else {
                fadeInElements.forEach(el => el.classList.add('is-visible'));
            }
            updateUIText();
        });
        const lenis = new Lenis({
          duration: 1.2,
          easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
          smooth: true,
        });
    function raf(time) {
      lenis.raf(time);
      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then((registration) => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        })
        .catch((error) => {
          console.log('ServiceWorker registration failed: ', error);
        });
    });
  }
</script>


    <script>//backup js for patient.html
        document.addEventListener('DOMContentLoaded', function() {
            let user = null, currentLanguage = 'en', bookingState = {}, currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear(), medicineCart = [], selectedPharmacy = null;

            const translations = {
                en: { welcome_message: "Welcome, {name}", welcome_subtitle: "Your health dashboard is ready.", next_appointment: "Next Appointment", new_prescriptions: "New Prescriptions", from_last_visit: "From past visits", home_nav: "Home", appointments_nav: "Appointments", records_nav: "Records", book_nav: "Book", more_nav: "More", appointments_title: "My Appointments", records_title: "Digital Health Record", book_title: "Book a Consultation", more_title: "More Options", prescriptions_title: "My Prescriptions", scan_medicine: "Scan Medicine", book_medicine: "Book Medicine", health_chatbot: "Health Chatbot", scan_medicine_title: "Scan Medicine", book_medicine_title: "Book Medicine", health_chatbot_title: "Health Assistant", select_pharmacy: "Select a Pharmacy"},
                hi: { welcome_message: "नमस्ते, {name}", welcome_subtitle: "आपका स्वास्थ्य डैशबोर्ड तैयार है।", next_appointment: "अगली अपॉइंटमेंट", new_prescriptions: "नई दवाइयाँ", from_last_visit: "पिछली मुलाक़ात से", home_nav: "होम", appointments_nav: "अपॉइंटमेंट्स", records_nav: "रिकॉर्ड्स", book_nav: "बुक करें", more_nav: "और", appointments_title: "मेरी अपॉइंटमेंट्स", records_title: "डिजिटल स्वास्थ्य रिकॉर्ड", book_title: "परामर्श बुक करें", more_title: "अन्य विकल्प", prescriptions_title: "मेरे नुस्खे", scan_medicine: "दवा स्कैन करें", book_medicine: "दवा बुक करें", health_chatbot: "स्वास्थ्य चैटबॉट", scan_medicine_title: "दवा स्कैन करें", book_medicine_title: "दवा बुक करें", health_chatbot_title: "स्वास्थ्य सहायक", select_pharmacy: "एक फार्मेसी चुनें"}
            };

            const appData = {
                records: [ { date: "2025-09-15", title: "Consultation with Dr. Priya Sharma", description: "Follow-up regarding skin rash. Prescription for ointment updated." }, { date: "2025-08-02", title: "Blood Test Report Uploaded", description: "Complete Blood Count (CBC) report added." } ],
                appointments: [
                    { doctor: "Dr. Anjali Verma", type: "General Physician", date: "2025-09-28", time: "04:30 PM", mode: "Video"},
                    { doctor: "Dr. Priya Sharma", type: "Child Specialist", date: "2025-09-15", time: "10:00 AM", mode: "Video", prescription: { medications: [{name: 'Paracetamol 500mg', dosage: '1 tablet thrice a day'}, {name: 'Azithromycin 250mg', dosage: '1 tablet daily'}] }},
                    { doctor: "Dr. Sameer Patel", type: "General Physician", date: "2025-09-20", time: "11:00 AM", mode: "Audio", prescription: { medications: [{name: 'Vitamin C 1000mg', dosage: '1 tablet daily'}] }}
                ],
                offlinePrescriptions: [{ doctor: "Local Store", type: "Offline", date: "2025-07-20", prescription: { medications: [{name: 'Antacid Syrup', dosage: '2 spoons after meals'}] }}],
                orders: [],
                pharmacy: [ 
                    {id: 1, name: "Apollo Pharmacy", address: "123, Park Street, Kolkata", delivery: "30-45 mins", contact: "9876543210"},
                    {id: 2, name: "Frank Ross", address: "45, AJC Bose Road, Kolkata", delivery: "45-60 mins", contact: "9876543211"},
                    {id: 3, name: "Wellness Forever", address: "78, Ballygunge Circular, Kolkata", delivery: "20-35 mins", contact: "9876543212"}
                ],
                medicines: [ {id: 1, name: "Paracetamol 500mg", price: 20}, {id: 2, name: "Aspirin 75mg", price: 15}, {id: 3, name: "Ibuprofen 200mg", price: 35}, {id: 4, name: "Antacid Syrup", price: 80}, {id: 5, name: "Vitamin C 1000mg", price: 120} ],
                booking: {
                    categories: ["General Physician", "Child Specialist", "Dermatologist"],
                    doctors: { "General Physician": [{name: "Dr. Anjali Verma", languages: "Hindi, English", img: "https://placehold.co/100x100/0d9488/FFFFFF?text=AV"}, {name: "Dr. Sameer Patel", languages: "Gujarati, Hindi", img: "https://placehold.co/100x100/3b82f6/FFFFFF?text=SP"}], "Child Specialist": [{name: "Dr. Priya Sharma", languages: "English, Hindi", img: "https://placehold.co/100x100/ec4899/FFFFFF?text=PS"}], "Dermatologist": [{name: "Dr. Rajesh Kumar", languages: "Bengali, Hindi", img: "https://placehold.co/100x100/8b5cf6/FFFFFF?text=RK"}], },
                    slots: ["10:00 AM", "11:30 AM", "02:00 PM", "04:30 PM"],
                    modes: ["Video Call", "Audio Call", "Photo-based"]
                }
            };
            
            function checkAuth() { user = { fullName: "Guest" }; }
            function updateUIText() { document.querySelectorAll('[data-key]').forEach(el => { const key = el.getAttribute('data-key'); let text = (translations[currentLanguage] || translations.en)[key]; if (key === 'welcome_message' && user) text = text.replace('{name}', user.fullName); if (text) el.textContent = text; }); }
            function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId)?.classList.add('active'); document.querySelectorAll('.nav-button, .top-nav a').forEach(link => { link.classList.toggle('active', link.dataset.screen === screenId); }); }
            
            function showConfirmationModal(title, message) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('confirmationModal').classList.add('active');
            }

            function setupNavigation() { 
                document.querySelectorAll('[data-screen]').forEach(el => { el.addEventListener('click', (e) => { e.preventDefault(); showScreen(el.dataset.screen); }); });
                document.getElementById('goToTrackOrdersBtn').addEventListener('click', () => showScreen('trackOrdersScreen'));
            }
            
            function setupThemeAndLanguage() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = document.getElementById('themeIcon');
                const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
                const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

                themeToggle.addEventListener('click', () => {
                    const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                    document.body.dataset.theme = newTheme;
                    themeIcon.innerHTML = newTheme === 'dark' ? sunIcon : moonIcon;
                });
                
                const langDropdown = document.querySelector('.language-dropdown');
                const langMenu = langDropdown.querySelector('.language-dropdown-menu');
                Object.keys(translations).forEach(lang => { const option = document.createElement('a'); option.href = "#"; option.className = 'language-option'; option.dataset.lang = lang; option.textContent = new Intl.DisplayNames([lang], { type: 'language' }).of(lang); langMenu.appendChild(option); });
                langDropdown.querySelector('.language-dropdown-toggle').addEventListener('click', () => langDropdown.classList.toggle('open'));
                document.addEventListener('click', e => { if (!langDropdown.contains(e.target)) langDropdown.classList.remove('open'); });
                langMenu.addEventListener('click', e => { if (e.target.classList.contains('language-option')) { currentLanguage = e.target.dataset.lang; document.getElementById('selectedLanguage').textContent = e.target.textContent; updateUIText(); langDropdown.classList.remove('open'); } });
            }

            function generateTimeline() { document.getElementById('timeline-container').innerHTML = appData.records.map(rec => `<div class="timeline-item"><div class="timeline-dot"></div><p class="timeline-date">${new Date(rec.date).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p><div class="card"><h4>${rec.title}</h4><p>${rec.description}</p></div></div>`).join(''); }

            function generateAppointments() {
                const container = document.getElementById('appointments-container');
                const now = new Date('2025-09-28T16:25:00');
                const upcoming = appData.appointments.filter(a => new Date(`${a.date} ${a.time}`) >= now).sort((a,b) => new Date(`${a.date} ${a.time}`) - new Date(`${b.date} ${b.time}`));
                const past = appData.appointments.filter(a => new Date(`${a.date} ${a.time}`) < now).sort((a,b) => new Date(`${b.date} ${b.time}`) - new Date(`${a.date} ${a.time}`));

                let html = `<h3 class="appointments-section-title">Upcoming</h3>`;
                html += upcoming.length ? upcoming.map(a => { const apptTime = new Date(`${a.date} ${a.time}`); const timeDiffMinutes = (apptTime - now) / 60000; const canJoin = timeDiffMinutes <= 10 && timeDiffMinutes >= -15; return `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${a.doctor}</h4><p>${a.type}</p><p>${new Date(a.date).toDateString()}, ${a.time}</p></div><span class="appointment-card-tag ${a.mode === 'Video' ? 'tag-video' : 'tag-audio'}">${a.mode}</span></div><div class="appointment-card-footer"><button class="btn" style="background: var(--color-secondary); color: var(--text-color);">Reschedule</button><button class="btn btn-primary join-call-btn" data-doctor="${a.doctor}" ${canJoin ? '' : 'disabled'}>Join Call</button></div></div>`; }).join('') : '<p>No upcoming appointments.</p>';
                
                html += `<h3 class="appointments-section-title" style="margin-top: 2rem;">Past</h3>`;
                html += past.length ? past.map((a, index) => `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${a.doctor}</h4><p>${a.type}</p><p>${new Date(a.date).toDateString()}, ${a.time}</p></div><span class="appointment-card-tag ${a.mode === 'Video' ? 'tag-video' : 'tag-audio'}">${a.mode}</span></div><div class="appointment-card-footer">${a.prescription ? `<button class="btn btn-primary view-prescription-btn" data-past-index="${index}">View Prescription</button>` : ''}</div></div>`).join('') : '<p>No past appointments.</p>';

                container.innerHTML = html;
                container.querySelectorAll('.join-call-btn').forEach(btn => btn.addEventListener('click', (e) => showCallScreen(e.currentTarget.dataset.doctor)));
                container.querySelectorAll('.view-prescription-btn').forEach(btn => btn.addEventListener('click', (e) => showPrescription(past[e.currentTarget.dataset.pastIndex])));
            }
            
            function generateAllPrescriptions() {
                const container = document.getElementById('prescriptions-container');
                const allPrescriptions = [...appData.appointments.filter(a => a.prescription), ...appData.offlinePrescriptions].sort((a, b) => new Date(b.date) - new Date(a.date));
                container.innerHTML = allPrescriptions.length ? allPrescriptions.map((p, index) => `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${p.doctor}</h4><p>${p.type}</p><p>${new Date(p.date).toDateString()}</p></div><span class="appointment-card-tag ${p.mode === 'Video' ? 'tag-video' : (p.mode === 'Audio' ? 'tag-audio' : 'tag-offline') }">${p.mode || 'Offline'}</span></div><div class="appointment-card-footer"><button class="btn btn-primary view-prescription-btn" data-index="${index}">View Prescription</button></div></div>`).join('') : '<p>No prescriptions found.</p>';
                container.querySelectorAll('.view-prescription-btn').forEach(btn => btn.addEventListener('click', e => showPrescription(allPrescriptions[e.currentTarget.dataset.index])));
            }

            function showCallScreen(doctorName) { document.getElementById('callWithDoctor').textContent = `Consultation with ${doctorName}`; document.getElementById('callScreen').classList.add('active'); }
            function showPrescription(appointment) {
                const modalContent = document.getElementById('prescriptionModalContent');
                modalContent.innerHTML = `<h3>Prescription</h3><div class="prescription-header"><p><strong>${appointment.mode ? 'Doctor' : 'Provider'}:</strong> ${appointment.doctor}</p><p><strong>Date:</strong> ${new Date(appointment.date).toDateString()}</p></div><ul class="prescription-med-list">${appointment.prescription.medications.map(med => `<li><strong>${med.name}</strong><br><small>${med.dosage}</small></li>`).join('')}</ul><button class="btn btn-primary" id="closePrescriptionModal">Close</button>`;
                document.getElementById('prescriptionModal').classList.add('active');
                document.getElementById('closePrescriptionModal').addEventListener('click', () => document.getElementById('prescriptionModal').classList.remove('active'), { once: true });
            }

            function renderBookingStep(step) {
                 document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
                 const stepEl = document.getElementById(`bookingStep${step}`);
                 if(stepEl) stepEl.classList.add('active');
                 document.getElementById('prevStep').disabled = step === 1;
                 document.getElementById('appointmentSummary').style.display = 'none';

                 let grid, data, handler;
                 if (step === 1) { grid = document.getElementById('categoryGrid'); data = appData.booking.categories; handler = (item) => { bookingState.category = item; renderBookingStep(2); }; grid.innerHTML = data.map(item => `<div class="selection-card card"><h4>${item}</h4></div>`).join(''); } 
                 else if (step === 2) { grid = document.getElementById('doctorGrid'); data = appData.booking.doctors[bookingState.category] || []; handler = (item) => { bookingState.doctor = item.name; renderBookingStep(3); }; grid.innerHTML = data.map(item => `<div class="doctor-card selection-card card"><img src="${item.img}"><h4>${item.name}</h4><p>${item.languages}</p></div>`).join(''); } 
                 else if (step === 3) { generateCalendar(); document.getElementById('timeSlotsGrid').innerHTML = ''; } 
                 else if (step === 4) { grid = document.getElementById('modeGrid'); data = appData.booking.modes; handler = (item) => { bookingState.mode = item; showSummary(); }; grid.innerHTML = data.map(item => `<div class="selection-card card"><h4>${item}</h4></div>`).join(''); }
                 if (grid) { Array.from(grid.children).forEach((child, index) => { child.addEventListener('click', () => handler(data[index])); }); }
            }
             function generateCalendar() {
                const daysGrid = document.getElementById('calendarDaysGrid');
                const monthYearEl = document.getElementById('currentMonthYear');
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                daysGrid.innerHTML = '';
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const today = new Date(); today.setHours(0, 0, 0, 0);
                document.getElementById('prevMonth').disabled = (currentYear < today.getFullYear() || (currentYear === today.getFullYear() && currentMonth <= today.getMonth()));

                for(let i = 0; i < firstDayOfMonth; i++) { daysGrid.insertAdjacentHTML('beforeend', '<div></div>'); }
                for(let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const currentDate = new Date(currentYear, currentMonth, day);
                    dayEl.textContent = day; dayEl.classList.add('calendar-day');
                    if (currentDate < today) { dayEl.classList.add('disabled'); } 
                    else { dayEl.classList.add('available'); dayEl.addEventListener('click', () => { bookingState.date = `${day} ${monthNames[currentMonth]} ${currentYear}`; document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected')); dayEl.classList.add('selected'); generateTimeSlots(); }); }
                    daysGrid.appendChild(dayEl);
                }
            }
            function generateTimeSlots() {
                const slotsGrid = document.getElementById('timeSlotsGrid');
                slotsGrid.innerHTML = appData.booking.slots.map(slot => `<div class="time-slot">${slot}</div>`).join('');
                slotsGrid.querySelectorAll('.time-slot').forEach(slotEl => { slotEl.addEventListener('click', () => { document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected')); slotEl.classList.add('selected'); bookingState.slot = slotEl.textContent; renderBookingStep(4); }); });
            }
            function showSummary() {
                document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
                const summaryEl = document.getElementById('appointmentSummary');
                summaryEl.style.display = 'block';
                summaryEl.innerHTML = `<h4>Appointment Summary</h4><p><strong>Category:</strong> ${bookingState.category}</p><p><strong>Doctor:</strong> ${bookingState.doctor}</p><p><strong>Date:</strong> ${bookingState.date}</p><p><strong>Time:</strong> ${bookingState.slot}</p><p><strong>Mode:</strong> ${bookingState.mode}</p><button class="btn btn-primary" id="confirmBtn" style="width:100%; margin-top:1rem;" data-key="book_confirm">Confirm</button>`;
                document.getElementById('confirmBtn').addEventListener('click', () => { showConfirmationModal('Appointment Booked!', 'Your appointment has been successfully scheduled.'); setTimeout(() => { document.getElementById('confirmationModal').classList.remove('active'); showScreen('homeScreen'); }, 2500); });
                updateUIText();
            }

            function generateOrdersList() {
                const container = document.getElementById('orders-list-container');
                if (appData.orders.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">You have no active or past medicine orders.</p>';
                    return;
                }
                container.innerHTML = appData.orders.sort((a,b) => new Date(b.date) - new Date(a.date)).map(order => `
                    <div class="card appointment-card">
                         <div class="appointment-card-header">
                            <div class="appointment-card-doctor">
                                <h4>Order ID: ${order.id}</h4>
                                <p>${order.pharmacyName}</p>
                                <p>Total: ₹${order.total}</p>
                            </div>
                            <span class="appointment-card-tag ${order.status === 'Delivered' ? 'tag-audio' : 'tag-video'}">${order.status}</span>
                        </div>
                        <div class="appointment-card-footer">
                            <button class="btn btn-primary track-order-list-btn" data-order-id="${order.id}">Track</button>
                        </div>
                    </div>
                `).join('');

                container.querySelectorAll('.track-order-list-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => showTrackingModal(e.currentTarget.dataset.orderId));
                });
            }

            function showTrackingModal(orderId) {
                const order = appData.orders.find(o => o.id === orderId);
                if (!order) return;

                const container = document.getElementById('trackingStatusContainer');
                const statuses = ['Order Placed', 'Preparing Order', 'Out for Delivery', 'Delivered'];
                const currentStatusIndex = statuses.indexOf(order.status);

                container.innerHTML = statuses.map((status, index) => {
                    const isCompleted = index <= currentStatusIndex;
                    return `
                        <div class="tracking-step ${isCompleted ? 'completed' : ''}">
                            <div class="tracking-dot">
                                ${isCompleted ? '&#10003;' : ''}
                            </div>
                            <p><strong>${status}</strong></p>
                        </div>
                    `;
                }).join('');

                document.getElementById('trackingModal').classList.add('active');
            }

            function setupModalsAndActions() {
                document.getElementById('closeModal').addEventListener('click', () => document.getElementById('confirmationModal').classList.remove('active'));
                document.getElementById('sosButton').addEventListener('click', () => document.getElementById('sosModal').classList.add('active'));
                document.getElementById('cancelSos').addEventListener('click', () => document.getElementById('sosModal').classList.remove('active'));
                document.getElementById('endCallBtn').addEventListener('click', () => document.getElementById('callScreen').classList.remove('active'));
                document.getElementById('closeTrackingModal').addEventListener('click', () => document.getElementById('trackingModal').classList.remove('active'));
                
                document.getElementById('confirmSos').addEventListener('click', () => { document.getElementById('sosModal').classList.remove('active'); showConfirmationModal('SOS Activated', 'Emergency services have been notified.'); });
                document.getElementById('reportIssueForm')?.addEventListener('submit', (e) => { e.preventDefault(); showConfirmationModal('Report Submitted', 'Your report has been sent for review.'); e.target.reset(); setTimeout(() => showScreen('moreScreen'), 2000); });
                document.getElementById('prevMonth').addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } generateCalendar(); });
                document.getElementById('nextMonth').addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } generateCalendar(); });
                document.getElementById('prevStep').addEventListener('click', () => { const currentStep = parseInt(document.querySelector('.booking-step.active').id.replace('bookingStep', '')); if (currentStep > 1) renderBookingStep(currentStep - 1); });
                document.getElementById('logoutBtn').addEventListener('click', () => { alert("You have been logged out."); window.location.reload(); });
                document.getElementById('viewAllPrescriptions').addEventListener('click', () => showScreen('prescriptionsScreen'));
            }

            function setupScanMedicine() {
                const cameraFeed = document.getElementById('camera-feed');
                const openCameraBtn = document.getElementById('openCameraBtn');
                const scanCodeBtn = document.getElementById('scanCodeBtn');
                const cameraStatus = document.getElementById('camera-status');
                openCameraBtn.addEventListener('click', async () => { try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); cameraFeed.srcObject = stream; await cameraFeed.play(); cameraStatus.textContent = "Camera is active. Point it at a QR code."; openCameraBtn.disabled = true; scanCodeBtn.disabled = false; } catch (err) { cameraStatus.textContent = "Could not access camera. Please check permissions."; console.error("Camera error:", err); } });
                scanCodeBtn.addEventListener('click', () => { showConfirmationModal("Scan Successful", "Medicine: Paracetamol 500mg. Batch No: P500-XYZ. Expiry: 12/2026. This is a genuine product."); });
            }
            
            function setupBookMedicine() {
                const pharmacySelectionContainer = document.getElementById('pharmacySelectionContainer');
                const medicineOrderingContainer = document.getElementById('medicineOrderingContainer');
                const pharmacyGrid = document.getElementById('pharmacyGrid');
                const searchInput = document.getElementById('medicineSearch');
                const medicineListEl = document.getElementById('medicineList');
                const checkoutBtn = document.getElementById('checkoutBtn');
                const selectedPharmacyNameEl = document.getElementById('selectedPharmacyName');
                const changePharmacyBtn = document.getElementById('changePharmacyBtn');
                
                const renderPharmacies = () => {
                    pharmacyGrid.innerHTML = appData.pharmacy.map(p => `
                        <div class="card pharmacy-card" data-pharmacy-id="${p.id}">
                           <div class="info">
                             <h4>${p.name}</h4>
                             <p><small>${p.address}</small></p>
                           </div>
                           <div class="actions">
                                <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 5.5a.5.5 0 0 0-1 0v3.5h3a.5.5 0 0 0 0-1h-2.5V5.5z"/><path d="M6.5 1A.5.5 0 0 1 7 .5h2a.5.5 0 0 1 0 1H7a.5.5 0 0 1-.5-.5zM8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg> ${p.delivery}</span>
                                <a href="tel:${p.contact}" class="btn btn-sm">Contact</a>
                           </div>
                        </div>
                    `).join('');
                    pharmacyGrid.querySelectorAll('.pharmacy-card').forEach(card => card.addEventListener('click', handlePharmacySelection));
                };

                const handlePharmacySelection = (e) => {
                    if(e.target.tagName === 'A') return; // Don't select if user clicks contact button
                    const pharmacyId = parseInt(e.currentTarget.dataset.pharmacyId);
                    selectedPharmacy = appData.pharmacy.find(p => p.id === pharmacyId);
                    
                    pharmacySelectionContainer.style.display = 'none';
                    medicineOrderingContainer.style.display = 'block';
                    selectedPharmacyNameEl.textContent = `Ordering from: ${selectedPharmacy.name}`;
                    renderMedicines();
                };

                const renderMedicines = (filter = '') => {
                    medicineListEl.innerHTML = appData.medicines
                        .filter(med => med.name.toLowerCase().includes(filter.toLowerCase()))
                        .map(med => `<li class="medicine-item">
                                        <span>${med.name} - ₹${med.price}</span>
                                        <button class="btn btn-primary btn-sm" data-med-id="${med.id}">${medicineCart.find(item => item.id === med.id) ? 'Added' : 'Add'}</button>
                                     </li>`)
                        .join('');
                };
                
                const resetAndShowPharmacies = () => {
                    pharmacySelectionContainer.style.display = 'block';
                    medicineOrderingContainer.style.display = 'none';
                    selectedPharmacy = null;
                    medicineCart = [];
                    updateCheckoutButton();
                    searchInput.value = '';
                };
                
                changePharmacyBtn.addEventListener('click', resetAndShowPharmacies);

                const updateCheckoutButton = () => { const count = medicineCart.length; checkoutBtn.textContent = `Checkout (${count} item${count === 1 ? '' : 's'})`; checkoutBtn.disabled = count === 0; };
                
                searchInput.addEventListener('input', (e) => renderMedicines(e.target.value));
                medicineListEl.addEventListener('click', (e) => { 
                    if (e.target.tagName === 'BUTTON') { 
                        const med = appData.medicines.find(m => m.id === parseInt(e.target.dataset.medId)); 
                        if(med && !medicineCart.find(item => item.id === med.id)) { 
                            medicineCart.push(med); 
                            updateCheckoutButton(); 
                            e.target.textContent = 'Added'; 
                            e.target.disabled = true; 
                        } 
                    } 
                });
                checkoutBtn.addEventListener('click', () => { 
                    const total = medicineCart.reduce((sum, item) => sum + item.price, 0);
                    const orderId = `SS-${Date.now()}`;
                    const newOrder = { id: orderId, pharmacyName: selectedPharmacy.name, items: [...medicineCart], total: total, deliveryEta: selectedPharmacy.delivery, status: 'Order Placed', date: new Date().toISOString().split('T')[0] };
                    appData.orders.push(newOrder);

                    const newRecord = { date: newOrder.date, title: `Medicine Order from ${newOrder.pharmacyName}`, description: `Ordered ${newOrder.items.length} items for a total of ₹${newOrder.total}. Order ID: ${newOrder.id}` };
                    appData.records.unshift(newRecord);
                    generateTimeline();
                    generateOrdersList();

                    // Simulate order progress
                    setTimeout(() => { const order = appData.orders.find(o=>o.id === orderId); if(order) {order.status = 'Preparing Order'; generateOrdersList();} }, 15000);
                    setTimeout(() => { const order = appData.orders.find(o=>o.id === orderId); if(order) {order.status = 'Out for Delivery'; generateOrdersList();} }, 45000);
                     setTimeout(() => { const order = appData.orders.find(o=>o.id === orderId); if(order) {order.status = 'Delivered'; generateOrdersList();} }, 90000);

                    showConfirmationModal(`Order Placed!`, `Your order from ${selectedPharmacy.name} will be delivered in ${selectedPharmacy.delivery}. You can track it from the 'Track My Orders' section.`);
                    resetAndShowPharmacies();
                });

                renderPharmacies();
            }

            function setupChatbot() {
                const chatForm = document.getElementById('chatForm');
                const chatInput = document.getElementById('chatInput');
                const chatWindow = document.getElementById('chatWindow');
                const addMessage = (text, sender) => { const msgEl = document.createElement('div'); msgEl.classList.add('chat-message', `${sender}-message`); msgEl.textContent = text; chatWindow.appendChild(msgEl); chatWindow.scrollTop = chatWindow.scrollHeight; };
                const getBotResponse = (input) => { const text = input.toLowerCase(); if (text.includes("hello") || text.includes("hi")) return "Hello! How can I assist with your health questions today?"; if (text.includes("headache")) return "For a mild headache, rest and hydration can help. Paracetamol is a common option. If it's severe or persistent, please consult a doctor."; if (text.includes("fever")) return "A fever is often a sign of infection. Monitor your temperature, rest, and drink fluids. If it's high or lasts more than two days, see a doctor."; if (text.includes("dosage") && text.includes("paracetamol")) return "For adults, the typical dosage for Paracetamol 500mg is 1-2 tablets every 4-6 hours, not exceeding 8 tablets in 24 hours. Always follow your doctor's advice."; return "I can provide general info on common symptoms. For specific medical advice, please consult a doctor."; };
                chatForm.addEventListener('submit', (e) => { e.preventDefault(); const userInput = chatInput.value.trim(); if (!userInput) return; addMessage(userInput, 'user'); chatInput.value = ''; setTimeout(() => { addMessage(getBotResponse(userInput), 'bot'); }, 600); });
                addMessage("Welcome to the Sehat Sahara Health Assistant. How can I help you?", "bot");
            }

            function initializeApp() {
                checkAuth();
                updateUIText();
                setupNavigation();
                setupThemeAndLanguage();
                generateTimeline();
                generateAppointments();
                generateAllPrescriptions();
                generateOrdersList();
                renderBookingStep(1);
                setupModalsAndActions();
                setupScanMedicine();
                setupBookMedicine();
                setupChatbot();
            }

            initializeApp();
        });
    </script>
</body>
</html>

<script>//backup for admin.html
        document.addEventListener('DOMContentLoaded', function() {
            const translations = {
                en: { dashboard: "Dashboard", user_management: "User Management", users_nav: "Users", grievances: "Grievances", payments: "Payments", logout: "Logout", admin_command_center: "Admin Command Center ⚙️", system_activity_view: "High-level view of system activity.", daily_consultations: "Daily Consultations", from_yesterday: "+5% from yesterday", active_users: "Active Users", user_types: "Doctors, Pharmacies, Saathis", disease_trends: "Disease Trends", most_reported_symptom: "Most reported symptom", fever: "Fever", medicine_stock: "Medicine Stock", average_availability: "Average availability", name: "Name", role: "Role", contact: "Contact", status: "Status", actions: "Actions", report_id: "Report ID", patient: "Patient", subject: "Subject", priority: "Priority", user: "User", amount: "Amount", date: "Date", verify: "Verify", suspend: "Suspend", unsuspend: "Un-suspend", remove: "Remove", view: "View", resolve: "Resolve", process: "Process", paid: "Paid", logged_out: "Logged Out", logged_out_message: "You have been successfully logged out." },
                hi: { dashboard: "डैशबोर्ड", user_management: "उपयोगकर्ता प्रबंधन", users_nav: "उपयोगकर्ता", grievances: "शिकायतें", payments: "भुगतान", logout: "लॉग आउट", admin_command_center: "व्यवस्थापक कमांड सेंटर ⚙️", system_activity_view: "सिस्टम गतिविधि का उच्च-स्तरीय दृश्य।", daily_consultations: "दैनिक परामर्श", from_yesterday: "कल से +5%", active_users: "सक्रिय उपयोगकर्ता", user_types: "डॉक्टर, फार्मेसी, साथी", disease_trends: "रोग की प्रवृत्ति", most_reported_symptom: "सबसे अधिक रिपोर्ट किया गया लक्षण", fever: "बुखार", medicine_stock: "दवा स्टॉक", average_availability: "औसत उपलब्धता", name: "नाम", role: "भूमिका", contact: "संपर्क", status: "स्थिति", actions: "कार्रवाइयाँ", report_id: "रिपोर्ट आईडी", patient: "मरीज़", subject: "विषय", priority: "प्राथमिकता", user: "उपयोगकर्ता", amount: "रकम", date: "तारीख", verify: "सत्यापित करें", suspend: "निलंबित करें", unsuspend: "निलंबन हटाएँ", remove: "हटाएँ", view: "देखें", resolve: "समाधान करें", process: "प्रोसेस करें", paid: "भुगतान किया गया", logged_out: "लॉग आउट", logged_out_message: "आप सफलतापूर्वक लॉग आउट हो गए हैं।" },
                pa: { dashboard: "ਡੈਸ਼ਬੋਰਡ", user_management: "ਉਪਭੋਗਤਾ ਪ੍ਰਬੰਧਨ", users_nav: "ਉਪਭੋਗਤਾ", grievances: "ਸ਼ਿਕਾਇਤਾਂ", payments: "ਭੁਗਤਾਨ", logout: "ਲੌਗ ਆਉਟ", admin_command_center: "ਪ੍ਰਸ਼ਾਸਕ ਕਮਾਂਡ ਸੈਂਟਰ ⚙️", system_activity_view: "ਸਿਸਟਮ ਗਤੀਵਿਧੀ ਦਾ ਉੱਚ-ਪੱਧਰੀ ਦ੍ਰਿਸ਼।", daily_consultations: "ਰੋਜ਼ਾਨਾ ਸਲਾਹ-ਮਸ਼ਵਰੇ", from_yesterday: "ਕੱਲ੍ਹ ਤੋਂ +5%", active_users: "ਸਰਗਰਮ ਉਪਭੋਗਤਾ", user_types: "ਡਾਕਟਰ, ਫਾਰਮੇਸੀ, ਸਾਥੀ", disease_trends: "ਬਿਮਾਰੀ ਦੇ ਰੁਝਾਨ", most_reported_symptom: "ਸਭ ਤੋਂ ਵੱਧ ਰਿਪੋਰਟ ਕੀਤੇ ਲੱਛਣ", fever: "ਬੁਖਾਰ", medicine_stock: "ਦਵਾਈਆਂ ਦਾ ਸਟਾਕ", average_availability: "ਔਸਤ ਉਪਲਬਧਤਾ", name: "ਨਾਮ", role: "ਭੂਮਿਕਾ", contact: "ਸੰਪਰਕ", status: "ਸਥਿਤੀ", actions: "ਕਾਰਵਾਈਆਂ", report_id: "ਰਿਪੋਰਟ ਆਈਡੀ", patient: "ਮਰੀਜ਼", subject: "ਵਿਸ਼ਾ", priority: "ਤਰਜੀਹ", user: "ਉਪਭੋਗਤਾ", amount: "ਰਕਮ", date: "ਮਿਤੀ", verify: "ਤਸਦੀਕ ਕਰੋ", suspend: "ਮੁਅੱਤਲ ਕਰੋ", unsuspend: "ਮੁਅੱਤਲੀ ਹਟਾਓ", remove: "ਹਟਾਓ", view: "ਵੇਖੋ", resolve: "ਹੱਲ ਕਰੋ", process: "ਪ੍ਰਕਿਰਿਆ", paid: "ਭੁਗਤਾਨ ਕੀਤਾ", logged_out: "ਲੌਗ ਆਉਟ", logged_out_message: "ਤੁਸੀਂ ਸਫਲਤਾਪੂਰਵਕ ਲੌਗ ਆਉਟ ਹੋ ਗਏ ਹੋ।" }
            };

            const appData = {
                en: {
                    users: [ { id: 1, name: "Dr. Anjali Verma", role: "Doctor", contact: "dr.anjali@ss.com", status: "Verified" }, { id: 2, name: "Wellness Pharmacy", role: "Pharmacy", contact: "wellness@ph.com", status: "Verified" }, { id: 3, name: "Ravi Kumar", role: "Sehat Saathi", contact: "ravi.k@ss.com", status: "Unverified" }, { id: 4, name: "Dr. Sameer Khan", role: "Doctor", contact: "dr.sameer@ss.com", status: "Suspended" }, { id: 5, name: "City Medicals", role: "Pharmacy", contact: "city.med@ph.com", status: "Verified" } ],
                    grievances: [ { id: 'G101', patient: "Amit Patel", subject: "Incorrect prescription", priority: "High", status: "Pending" }, { id: 'G102', patient: "Sunita Reddy", subject: "Doctor did not join call", priority: "High", status: "Pending" }, { id: 'G103', patient: "Karan Verma", subject: "Payment failed", priority: "Medium", status: "Resolved" } ],
                    payments: [ { id: 1, user: "Dr. Anjali Verma", role: "Doctor", amount: 12500, date: "2025-09-28", status: "Paid" }, { id: 2, user: "Ravi Kumar", role: "Sehat Saathi", amount: 3500, date: "2025-09-28", status: "Pending" }, { id: 3, user: "Dr. Sameer Khan", role: "Doctor", amount: 9800, date: "2025-09-28", status: "Paid" } ],
                    status_map: { Verified: "Verified", Unverified: "Unverified", Suspended: "Suspended", High: "High", Medium: "Medium", Pending: "Pending", Resolved: "Resolved", Paid: "Paid" }
                },
                hi: {
                    users: [ { id: 1, name: "डॉ. अंजलि वर्मा", role: "चिकित्सक", contact: "dr.anjali@ss.com", status: "सत्यापित" }, { id: 2, name: "वेलनेस फार्मेसी", role: "फार्मेसी", contact: "wellness@ph.com", status: "सत्यापित" }, { id: 3, name: "रवि कुमार", role: "सेहत साथी", contact: "ravi.k@ss.com", status: "असत्यापित" }, { id: 4, name: "डॉ. समीर खान", role: "चिकित्सक", contact: "dr.sameer@ss.com", status: "निलंबित" }, { id: 5, name: "सिटी मेडिकल्स", role: "फार्मेसी", contact: "city.med@ph.com", status: "सत्यापित" } ],
                    grievances: [ { id: 'G101', patient: "अमित पटेल", subject: "गलत नुस्खा", priority: "उच्च", status: "लंबित" }, { id: 'G102', patient: "सुनीता रेड्डी", subject: "डॉक्टर कॉल में शामिल नहीं हुए", priority: "उच्च", status: "लंबित" }, { id: 'G103', patient: "करण वर्मा", subject: "भुगतान विफल", priority: "मध्यम", status: "हल हो गया" } ],
                    payments: [ { id: 1, user: "डॉ. अंजलि वर्मा", role: "चिकित्सक", amount: 12500, date: "2025-09-28", status: "भुगतान किया गया" }, { id: 2, user: "रवि कुमार", role: "सेहत साथी", amount: 3500, date: "2025-09-28", status: "लंबित" }, { id: 3, user: "डॉ. समीर खान", role: "चिकित्सक", amount: 9800, date: "2025-09-28", status: "भुगतान किया गया" } ],
                    status_map: { Verified: "सत्यापित", Unverified: "असत्यापित", Suspended: "निलंबित", High: "उच्च", Medium: "मध्यम", Pending: "लंबित", Resolved: "हल हो गया", Paid: "भुगतान किया गया" }
                },
                pa: {
                    users: [ { id: 1, name: "ਡਾ. ਅੰਜਲੀ ਵਰਮਾ", role: "ਡਾਕਟਰ", contact: "dr.anjali@ss.com", status: "ਤਸਦੀਕਸ਼ੁਦਾ" }, { id: 2, name: "ਵੈਲਨੈਸ ਫਾਰਮੇਸੀ", role: "ਫਾਰਮੇਸੀ", contact: "wellness@ph.com", status: "ਤਸਦੀਕਸ਼ੁਦਾ" }, { id: 3, name: "ਰਵੀ ਕੁਮਾਰ", role: "ਸਿਹਤ ਸਾਥੀ", contact: "ravi.k@ss.com", status: "ਗੈਰ-ਪ੍ਰਮਾਣਿਤ" }, { id: 4, name: "ਡਾ. ਸਮੀਰ ਖਾਨ", role: "ਡਾਕਟਰ", contact: "dr.sameer@ss.com", status: "ਮੁਅੱਤਲ" }, { id: 5, name: "ਸਿਟੀ ਮੈਡੀਕਲਜ਼", role: "ਫਾਰਮੇਸੀ", contact: "city.med@ph.com", status: "ਤਸਦੀਕਸ਼ੁਦਾ" } ],
                    grievances: [ { id: 'G101', patient: "ਅਮਿਤ ਪਟੇਲ", subject: "ਗਲਤ ਨੁਸਖ਼ਾ", priority: "ਉੱਚ", status: "ਬਕਾਇਆ" }, { id: 'G102', patient: "ਸੁਨੀਤਾ ਰੈੱਡੀ", subject: "ਡਾਕਟਰ ਕਾਲ ਵਿੱਚ ਸ਼ਾਮਲ ਨਹੀਂ ਹੋਏ", priority: "ਉੱਚ", status: "ਬਕਾਇਆ" }, { id: 'G103', patient: "ਕਰਨ ਵਰਮਾ", subject: "ਭੁਗਤਾਨ ਅਸਫਲ", priority: "ਮੱਧਮ", status: "ਹੱਲ ਹੋ ਗਿਆ" } ],
                    payments: [ { id: 1, user: "ਡਾ. ਅੰਜਲੀ ਵਰਮਾ", role: "ਡਾਕਟਰ", amount: 12500, date: "2025-09-28", status: "ਭੁਗਤਾਨ ਕੀਤਾ" }, { id: 2, user: "ਰਵੀ ਕੁਮਾਰ", role: "ਸਿਹਤ ਸਾਥੀ", amount: 3500, date: "2025-09-28", status: "ਬਕਾਇਆ" }, { id: 3, user: "ਡਾ. ਸਮੀਰ ਖਾਨ", role: "ਡਾਕਟਰ", amount: 9800, date: "2025-09-28", status: "ਭੁਗਤਾਨ ਕੀਤਾ" } ],
                    status_map: { Verified: "ਤਸਦੀਕਸ਼ੁਦਾ", Unverified: "ਗੈਰ-ਪ੍ਰਮਾਣਿਤ", Suspended: "ਮੁਅੱਤਲ", High: "ਉੱਚ", Medium: "ਮੱਧਮ", Pending: "ਬਕਾਇਆ", Resolved: "ਹੱਲ ਹੋ ਗਿਆ", Paid: "ਭੁਗਤਾਨ ਕੀਤਾ" }
                }
            };
            let currentLanguage = 'en';

            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId)?.classList.add('active');
                
                document.querySelectorAll('.nav-button, .top-nav a').forEach(link => {
                    link.classList.toggle('active', link.dataset.screen === screenId);
                });
            }
            
            function setupNavigation() {
                document.querySelectorAll('[data-screen]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        showScreen(el.dataset.screen);
                    });
                });
            }

            function setupThemeAndLanguage() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = document.getElementById('themeIcon');
                const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
                const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.body.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    document.body.setAttribute('data-theme', newTheme);
                    themeIcon.innerHTML = newTheme === 'dark' ? sunIcon : moonIcon;
                });
                
                const langDropdown = document.querySelector('.language-dropdown');
                const langMenu = langDropdown.querySelector('.language-dropdown-menu');
                const langOptions = { en: "English", hi: "हिन्दी", pa: "ਪੰਜਾਬੀ" };

                Object.keys(langOptions).forEach(lang => {
                    const option = document.createElement('a');
                    option.href = "#"; option.className = 'language-option'; option.dataset.lang = lang;
                    option.textContent = langOptions[lang];
                    langMenu.appendChild(option);
                });

                langDropdown.querySelector('.language-dropdown-toggle').addEventListener('click', () => langDropdown.classList.toggle('open'));
                document.addEventListener('click', e => { if (!langDropdown.contains(e.target)) langDropdown.classList.remove('open'); });
                
                langMenu.addEventListener('click', e => {
                    e.preventDefault();
                    if (e.target.classList.contains('language-option')) {
                        currentLanguage = e.target.dataset.lang;
                        document.getElementById('selectedLanguage').textContent = e.target.textContent;
                        updateUI();
                        langDropdown.classList.remove('open');
                    }
                });
            }

            function updateUIText() {
                const langPack = translations[currentLanguage] || translations.en;
                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.getAttribute('data-key');
                    if (langPack[key]) {
                        el.textContent = langPack[key];
                    }
                });
            }

            function getStatusClass(status) {
                const statusClassMap = {
                    "Verified": "verified", "Resolved": "resolved", "Paid": "paid",
                    "Suspended": "suspended", "High": "high",
                    "Unverified": "unverified", "Pending": "pending", "Medium": "medium"
                };
                 const englishStatus = Object.keys(appData.en.status_map).find(key => 
                    appData.en.status_map[key] === status || 
                    appData.hi.status_map[key] === status || 
                    appData.pa.status_map[key] === status
                );
                return statusClassMap[englishStatus] || 'neutral';
            }


            function populateUserTable() {
                const tableBody = document.querySelector('#userTable tbody');
                const data = appData[currentLanguage].users;
                const langPack = translations[currentLanguage];
                tableBody.innerHTML = data.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>${user.contact}</td>
                        <td><span class="status-badge status-${getStatusClass(user.status)}">${user.status}</span></td>
                        <td class="actions-cell">
                            ${user.status === appData[currentLanguage].status_map.Unverified ? `<button class="btn btn-sm btn-primary">${langPack.verify}</button>` : ''}
                            ${user.status !== appData[currentLanguage].status_map.Suspended ? `<button class="btn btn-sm btn-sos">${langPack.suspend}</button>` : `<button class="btn btn-sm btn-primary">${langPack.unsuspend}</button>`}
                            <button class="btn btn-sm btn-neutral">${langPack.remove}</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            function populateGrievanceTable() {
                 const tableBody = document.querySelector('#grievanceTable tbody');
                 const data = appData[currentLanguage].grievances;
                 const langPack = translations[currentLanguage];
                tableBody.innerHTML = data.map(g => `
                    <tr>
                        <td>${g.id}</td>
                        <td>${g.patient}</td>
                        <td>${g.subject}</td>
                        <td><span class="status-badge status-${getStatusClass(g.priority)}">${g.priority}</span></td>
                        <td><span class="status-badge status-${getStatusClass(g.status)}">${g.status}</span></td>
                        <td class="actions-cell">
                            <button class="btn btn-sm btn-primary">${langPack.view}</button>
                             ${g.status === appData[currentLanguage].status_map.Pending ? `<button class="btn btn-sm btn-neutral">${langPack.resolve}</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }

            function populatePaymentTable() {
                const tableBody = document.querySelector('#paymentTable tbody');
                const data = appData[currentLanguage].payments;
                const langPack = translations[currentLanguage];
                tableBody.innerHTML = data.map(p => `
                    <tr>
                        <td>${p.user}</td>
                        <td>${p.role}</td>
                        <td>₹${p.amount.toLocaleString()}</td>
                        <td>${p.date}</td>
                        <td><span class="status-badge status-${getStatusClass(p.status)}">${p.status}</span></td>
                        <td class="actions-cell">
                            ${p.status === appData[currentLanguage].status_map.Pending ? `<button class="btn btn-sm btn-primary">${langPack.process}</button>` : `<button class="btn btn-sm btn-neutral" disabled>${langPack.paid}</button>`}
                        </td>
                    </tr>
                `).join('');
            }

            function setupModals() {
                document.getElementById('closeModal').addEventListener('click', () => document.getElementById('confirmationModal').classList.remove('active'));
            }

            function showConfirmationModal(titleKey, messageKey) {
                const langPack = translations[currentLanguage];
                document.getElementById('modalTitle').textContent = langPack[titleKey];
                document.getElementById('modalMessage').textContent = langPack[messageKey];
                document.getElementById('confirmationModal').classList.add('active');
            }
            
            function updateUI(){
                updateUIText();
                populateUserTable();
                populateGrievanceTable();
                populatePaymentTable();
            }

            function initializeApp() {
                setupNavigation();
                setupThemeAndLanguage();
                setupModals();
                updateUI();
                
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    showConfirmationModal("logged_out", "logged_out_message");
                });
            }

            initializeApp();
        });
    </script>

<script>//backup for edited code of patient gemini bkchodi
    document.addEventListener('DOMContentLoaded', function() {
        // --- Global State ---
        let user = null;
        let currentLanguage = 'en';
        let bookingState = {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let medicineCart = [];
        let selectedPharmacy = null;

        // --- API Base URL ---
        // For local testing, this points to your Flask app.
        // For deployment, change this to your Render URL.
        const API_BASE_URL = 'https://sahara-sathi.onrender.com/';

        // --- Translations ---
        const translations = {
            en: { welcome_message: "Welcome, {name}", welcome_subtitle: "Your health dashboard is ready.", next_appointment: "Next Appointment", new_prescriptions: "New Prescriptions", from_last_visit: "From past visits", home_nav: "Home", appointments_nav: "Appointments", records_nav: "Records", book_nav: "Book", more_nav: "More", appointments_title: "My Appointments", records_title: "Digital Health Record", book_title: "Book a Consultation", more_title: "More Options", prescriptions_title: "My Prescriptions", scan_medicine: "Scan Medicine", book_medicine: "Book Medicine", health_chatbot: "Health Chatbot", scan_medicine_title: "Scan Medicine", book_medicine_title: "Book Medicine", health_chatbot_title: "Health Assistant", select_pharmacy: "Select a Pharmacy"},
            hi: { welcome_message: "नमस्ते, {name}", welcome_subtitle: "आपका स्वास्थ्य डैशबोर्ड तैयार है।", next_appointment: "अगली अपॉइंटमेंट", new_prescriptions: "नई दवाइयाँ", from_last_visit: "पिछली मुलाक़ात से", home_nav: "होम", appointments_nav: "अपॉइंटमेंट्स", records_nav: "रिकॉर्ड्स", book_nav: "बुक करें", more_nav: "और", appointments_title: "मेरी अपॉइंटमेंट्स", records_title: "डिजिटल स्वास्थ्य रिकॉर्ड", book_title: "परामर्श बुक करें", more_title: "अन्य विकल्प", prescriptions_title: "मेरे नुस्खे", scan_medicine: "दवा स्कैन करें", book_medicine: "दवा बुक करें", health_chatbot: "स्वास्थ्य चैटबॉट", scan_medicine_title: "दवा स्कैन करें", book_medicine_title: "दवा बुक करें", health_chatbot_title: "स्वास्थ्य सहायक", select_pharmacy: "एक फार्मेसी चुनें"}
        };
        
        // --- Authentication & Initialization ---
        function initializeApp() {
            const userData = localStorage.getItem('sehatSaharaUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            user = JSON.parse(userData);

            // Initial UI setup and data fetching
            updateUIText();
            setupNavigation();
            setupThemeAndLanguage();
            setupModalsAndActions();
            setupChatbot();
            renderBookingStep(1); 
            setupBookMedicine();
            setupScanMedicine();
            generateOrdersList(); // Initially generate with empty data for now

            // Fetch all dynamic data from the backend
            loadDashboardData();
            loadAppointments();
            loadHealthRecords();
            // Note: Prescriptions & Orders need dedicated GET endpoints in the backend
            generateAllPrescriptions([]); 
        }

        // --- API Fetching Functions ---
        async function fetchApi(endpoint, options = {}) {
            const defaultOptions = {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            };
            const mergedOptions = { ...defaultOptions, ...options };

            // For GET requests, user is identified by the session cookie on the backend.
            // For POST/PUT, we add userId to the body if not already present.
            if (user && user.patientId && mergedOptions.body) {
                let body = JSON.parse(mergedOptions.body);
                if (!body.userId) {
                    body.userId = user.patientId;
                }
                mergedOptions.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, mergedOptions);
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('sehatSaharaUser');
                        window.location.href = 'index.html';
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch ${endpoint}:`, error);
                showConfirmationModal('Error', 'Could not connect to the server.');
                return null;
            }
        }

        async function loadDashboardData() {
            const data = await fetchApi('/v1/dashboard');
            if (data && data.success) {
                document.getElementById('welcomeMessage').textContent = `Welcome, ${data.fullName}`;
                const nextAppointmentCard = document.querySelector('.info-grid .info-card:first-child');
                if (data.nextAppointment) {
                    const apptDate = new Date(data.nextAppointment.dateTime);
                    nextAppointmentCard.querySelector('.highlight').textContent = `${apptDate.toLocaleDateString()}, ${apptDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    nextAppointmentCard.querySelector('p:last-child').textContent = data.nextAppointment.doctorName;
                } else {
                    nextAppointmentCard.querySelector('.highlight').textContent = "No upcoming appointments";
                    nextAppointmentCard.querySelector('p:last-child').textContent = "Book one now!";
                }
                const prescriptionsCard = document.querySelector('.info-grid .info-card:last-child');
                prescriptionsCard.querySelector('.highlight').textContent = `${data.prescriptionCount} Total`;
            }
        }
        
        async function loadAppointments() {
            const data = await fetchApi('/v1/appointments');
            if (data && data.success) {
                generateAppointments(data.appointments);
            }
        }
        
        async function loadHealthRecords() {
            const data = await fetchApi('/v1/dashboard'); // Re-using dashboard for now
            if (data && data.success) {
                generateTimeline(data.healthRecords);
            }
        }

        // --- UI Rendering Functions ---
        function updateUIText() { document.querySelectorAll('[data-key]').forEach(el => { const key = el.getAttribute('data-key'); let text = (translations[currentLanguage] || translations.en)[key]; if (key === 'welcome_message' && user) text = text.replace('{name}', user.fullName); if (text) el.textContent = text; }); }
        
        function generateTimeline(records = []) { 
            const container = document.getElementById('timeline-container');
            if (!records || records.length === 0) {
                container.innerHTML = '<p>No health records found.</p>';
                return;
            }
            container.innerHTML = records.map(rec => `<div class="timeline-item"><div class="timeline-dot"></div><p class="timeline-date">${new Date(rec.date).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p><div class="card"><h4>${rec.title}</h4><p>${rec.description}</p></div></div>`).join(''); 
        }
        
        function generateAppointments(appointments = []) {
            const container = document.getElementById('appointments-container');
            const now = new Date();
            
            const upcoming = appointments.filter(a => new Date(a.dateTime) >= now).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
            const past = appointments.filter(a => new Date(a.dateTime) < now).sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));

            let html = `<h3 class="appointments-section-title">Upcoming</h3>`;
            html += upcoming.length ? upcoming.map(a => {
                const apptTime = new Date(a.dateTime);
                const timeDiffMinutes = (apptTime - now) / 60000;
                const canJoin = timeDiffMinutes <= 15 && timeDiffMinutes >= -30; // Join window
                return `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${a.doctorName}</h4><p>${a.specialization}</p><p>${apptTime.toLocaleString()}</p></div><span class="appointment-card-tag tag-video">${a.type}</span></div><div class="appointment-card-footer"><button class="btn btn-primary join-call-btn" data-doctor="${a.doctorName}" ${canJoin ? '' : 'disabled'}>Join Call</button></div></div>`;
            }).join('') : '<p>No upcoming appointments.</p>';
            
            html += `<h3 class="appointments-section-title" style="margin-top: 2rem;">Past</h3>`;
            html += past.length ? past.map(a => `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${a.doctorName}</h4><p>${a.specialization}</p><p>${new Date(a.dateTime).toLocaleString()}</p></div></div></div>`).join('') : '<p>No past appointments.</p>';

            container.innerHTML = html;
            container.querySelectorAll('.join-call-btn').forEach(btn => btn.addEventListener('click', (e) => showCallScreen(e.currentTarget.dataset.doctor)));
        }
        
        function generateAllPrescriptions(prescriptions = []) {
            const container = document.getElementById('prescriptions-container');
            // This needs a dedicated GET /v1/prescriptions endpoint
            container.innerHTML = '<p>Your prescription history will appear here.</p>';
        }

        function generateOrdersList(orders = []) {
            const container = document.getElementById('orders-list-container');
             // This needs a dedicated GET /v1/orders endpoint
            container.innerHTML = '<p>Your medicine order history will appear here.</p>';
        }

        function showCallScreen(doctorName) { document.getElementById('callWithDoctor').textContent = `Consultation with ${doctorName}`; document.getElementById('callScreen').classList.add('active'); }
        function showPrescription(appointment) { /* ... same as original ... */ }
        function showTrackingModal(orderId) { /* ... same as original ... */ }
        
        // --- Booking Flow ---
        async function renderBookingStep(step) {
             document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
             document.getElementById(`bookingStep${step}`)?.classList.add('active');
             document.getElementById('prevStep').disabled = step === 1;
             document.getElementById('appointmentSummary').style.display = 'none';

             if (step === 1) { 
                 const categories = ["General Physician", "Child Specialist", "Dermatologist"];
                 const grid = document.getElementById('categoryGrid');
                 grid.innerHTML = categories.map(item => `<div class="selection-card card" data-item="${item}"><h4>${item}</h4></div>`).join('');
                 grid.querySelectorAll('.selection-card').forEach(card => card.addEventListener('click', (e) => {
                     bookingState.category = e.currentTarget.dataset.item;
                     renderBookingStep(2);
                 }));
             } else if (step === 2) {
                 const data = await fetchApi(`/v1/doctors?specialty=${bookingState.category}`);
                 if (data && data.success) {
                     const grid = document.getElementById('doctorGrid');
                     grid.innerHTML = data.doctors.map(doc => `<div class="doctor-card selection-card card" data-item='${JSON.stringify(doc)}'><img src="https://placehold.co/100x100/0d9488/FFFFFF?text=${doc.name.charAt(0)}"><h4>${doc.name}</h4><p>${doc.languages.join(', ')}</p></div>`).join('');
                     grid.querySelectorAll('.selection-card').forEach(card => card.addEventListener('click', (e) => {
                         bookingState.doctor = JSON.parse(e.currentTarget.dataset.item);
                         renderBookingStep(3);
                     }));
                 }
             } else if (step === 3) { generateCalendar(); document.getElementById('timeSlotsGrid').innerHTML = ''; } 
             else if (step === 4) { 
                 const modes = ["Video Call", "Audio Call", "Photo-based"];
                 const grid = document.getElementById('modeGrid');
                 grid.innerHTML = modes.map(item => `<div class="selection-card card" data-item="${item}"><h4>${item}</h4></div>`).join('');
                 grid.querySelectorAll('.selection-card').forEach(card => card.addEventListener('click', (e) => {
                     bookingState.mode = e.currentTarget.dataset.item;
                     showSummary();
                 }));
             }
        }
        function generateCalendar() { /* ... client-side logic same as original ... */ }
        function generateTimeSlots() { /* ... client-side logic same as original ... */ }
        
        async function showSummary() {
            document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
            const summaryEl = document.getElementById('appointmentSummary');
            summaryEl.style.display = 'block';
            summaryEl.innerHTML = `<h4>Appointment Summary</h4><p><strong>Doctor:</strong> ${bookingState.doctor.name}</p><p><strong>Date:</strong> ${bookingState.date}</p><p><strong>Time:</strong> ${bookingState.slot}</p><p><strong>Mode:</strong> ${bookingState.mode}</p><button class="btn btn-primary" id="confirmBtn" style="width:100%; margin-top:1rem;">Confirm</button>`;
            
            document.getElementById('confirmBtn').addEventListener('click', async () => {
                const button = document.getElementById('confirmBtn');
                button.disabled = true; button.textContent = 'Booking...';

                // Robust date parsing
                const dateParts = bookingState.date.split(' '); // "29 September 2025"
                const timeParts = bookingState.slot.match(/(\d+):(\d+)\s*(AM|PM)/);
                let hours = parseInt(timeParts[1], 10);
                if (timeParts[3] === 'PM' && hours < 12) hours += 12;
                if (timeParts[3] === 'AM' && hours === 12) hours = 0;
                const minutes = parseInt(timeParts[2], 10);
                const monthIndex = new Date(Date.parse(dateParts[1] +" 1, 2012")).getMonth();
                const appointmentDateTime = new Date(dateParts[2], monthIndex, dateParts[0], hours, minutes);

                const payload = {
                    doctorId: bookingState.doctor.id,
                    appointmentDatetime: appointmentDateTime.toISOString(),
                    appointmentType: bookingState.mode.split(' ')[0].toLowerCase(),
                    chiefComplaint: "General Consultation"
                };
                const result = await fetchApi('/v1/book-doctor', { method: 'POST', body: JSON.stringify(payload) });
                if (result && result.success) {
                    showConfirmationModal('Appointment Booked!', 'Your appointment has been successfully scheduled.');
                    loadAppointments(); // Refresh the appointments list
                    setTimeout(() => { document.getElementById('confirmationModal').classList.remove('active'); showScreen('appointmentsScreen'); }, 2500);
                } else {
                    showConfirmationModal('Booking Failed', result ? result.message : 'Could not book the appointment.');
                }
                button.disabled = false; button.textContent = 'Confirm';
            });
        }

        // --- Medicine Booking Flow ---
        async function setupBookMedicine() {
            const pharmacyGrid = document.getElementById('pharmacyGrid');
            const searchInput = document.getElementById('medicineSearch');
            const medicineListEl = document.getElementById('medicineList');
            const checkoutBtn = document.getElementById('checkoutBtn');

            const data = await fetchApi('/v1/pharmacies');
            if (data && data.success) {
                // Same pharmacy rendering logic as your original file
            }
            // Add all other event listeners from your original file's `setupBookMedicine`
        }

        // --- Chatbot Logic ---
        function setupChatbot() {
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');
            const chatWindow = document.getElementById('chatWindow');
            const addMessage = (text, sender) => { const msgEl = document.createElement('div'); msgEl.classList.add('chat-message', `${sender}-message`); msgEl.textContent = text; chatWindow.appendChild(msgEl); chatWindow.scrollTop = chatWindow.scrollHeight; };
            
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = chatInput.value.trim();
                if (!userInput || !user) return;

                addMessage(userInput, 'user');
                chatInput.value = '';
                addMessage("...", 'bot');

                const data = await fetchApi('/v1/predict', {
                    method: 'POST',
                    body: JSON.stringify({ message: userInput, userId: user.patientId })
                });

                chatWindow.removeChild(chatWindow.lastChild);

                if (data && !data.error) {
                    addMessage(data.response, 'bot');
                    handleBotAction(data.action, data.parameters);
                } else {
                    addMessage(data ? data.message : "I'm having trouble connecting.", 'bot');
                }
            });
            addMessage("Welcome to the Sehat Sahara Health Assistant. How can I help you?", "bot");
        }
        
        function handleBotAction(action, parameters) {
            console.log("Action:", action, "Parameters:", parameters);
            if (action === "NAVIGATE_TO_APPOINTMENT_BOOKING") showScreen('bookingScreen');
            else if (action === "FETCH_APPOINTMENTS") showScreen('appointmentsScreen');
        }
        
        // --- General Setup ---
        function showConfirmationModal(title, message) { /* ... same as original ... */ }
        function setupNavigation() { /* ... same as original ... */ }
        function setupThemeAndLanguage() { /* ... same as original ... */ }
        function setupScanMedicine() { /* ... same as original ... */ }
        function setupModalsAndActions() {
            // All modal and action setup from your original file
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('sehatSaharaUser');
                fetchApi('/v1/logout', { method: 'POST' }); // Inform backend
                window.location.href = 'index.html';
            });
            // ... add other listeners like prev/next month, SOS, etc.
        }

        // --- Start Application ---
        initializeApp();
    });
</script>